generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY: Organização (Conta Principal)
// ============================================
model Organization {
  id          String   @id @default(cuid())
  name        String                         // Nome da organização/conta
  slug        String   @unique               // URL amigável (ex: "ps-srq")
  shareCode   String   @unique               // Código de compartilhamento (ex: "AIRX-7K9M2")
  plan        String   @default("FREE")      // FREE, STARTER, PRO, ENTERPRISE
  status      String   @default("ACTIVE")    // ACTIVE, SUSPENDED, CANCELLED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  members     OrganizationMember[]
  aircraft    Aircraft[]
  flights     Flight[]
  expenses    Expense[]
  bookings    Booking[]
}

// Membros da Organização (relacionamento User <-> Organization)
model OrganizationMember {
  id             String   @id @default(cuid())
  role           String   @default("VIEWER")  // OWNER, ADMIN, CONTROLLER, PILOT, VIEWER
  ownershipPct   Decimal? @default(0)         // Percentual de participação na aeronave
  status         String   @default("ACTIVE")  // ACTIVE, INVITED, INACTIVE
  joinedAt       DateTime @default(now())
  updatedAt      DateTime @updatedAt

  userId         String
  organizationId String

  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
}

model User {
  id             String     @id @default(cuid())
  name           String
  email          String     @unique
  hashedPassword String
  role           String     @default("VIEWER")  // Role global (para admin do sistema)
  status         String     @default("ACTIVE")
  phone          String?
  ownershipPct   Decimal?   @default(0)  // Deprecado - usar OrganizationMember.ownershipPct
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Organizações do usuário
  organizations    OrganizationMember[]
  
  flightsAsPilot   Flight[]   @relation("FlightPilot")
  flightsAsPayer   Flight[]   @relation("FlightPayer")
  flightsAsUsedBy  Flight[]   @relation("FlightUsedBy")
  expenses         Expense[]
  sessions         Session[]
  
  // Reservas
  bookingsReserved Booking[]  @relation("BookingReservedBy")
  bookingsAsPilot  Booking[]  @relation("BookingPilot")
  calendarIntegration CalendarIntegration?
}

model Aircraft {
  id              String   @id @default(cuid())
  tailNumber      String   @unique  // Matrícula é única globalmente (padrão ANAC)
  model           String
  manufacturer    String?
  year            Int?
  status          String?  @default("AVAILABLE")
  totalHours      Decimal? @default(0)
  nextMaintenance DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Multi-tenancy
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  flights  Flight[]
  bookings Booking[]
}

model Flight {
  id                  String    @id @default(cuid())
  flightDate          DateTime
  origin              String
  destination         String
  distanceNm          Decimal?
  fuelStart           Decimal?
  fuelEnd             Decimal?
  durationHours       Decimal?
  baseAbsorption      String?
  baseFixedAbsorption String?
  baseTax             Decimal?
  travelExpenses      Decimal?  @default(0)
  maintenanceExpenses Decimal?  @default(0)
  totalCost           Decimal?  @default(0)
  notes               String?
  attachment          String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Multi-tenancy
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  pilotId    String?
  payerId    String?
  aircraftId String?
  usedById   String?

  pilot    User?     @relation("FlightPilot", fields: [pilotId], references: [id])
  payer    User?     @relation("FlightPayer", fields: [payerId], references: [id])
  usedBy   User?     @relation("FlightUsedBy", fields: [usedById], references: [id])
  aircraft Aircraft? @relation(fields: [aircraftId], references: [id])

  expenses Expense[]
}

model Expense {
  id          String   @id @default(cuid())
  expenseDate DateTime
  category    String
  amount      Decimal
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Multi-tenancy
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  paidById String?
  flightId String?

  paidBy User?   @relation(fields: [paidById], references: [id])
  flight Flight? @relation(fields: [flightId], references: [id])
}

model DemoRequest {
  id            String   @id @default(cuid())
  name          String
  email         String
  phone         String?
  company       String?
  preferredDate DateTime?
  message       String?
  status        String   @default("PENDING")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  ip        String?
  userAgent String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Sistema de Reservas de Voo
model Booking {
  id              String    @id @default(cuid())
  title           String
  startDate       DateTime
  endDate         DateTime
  purpose         String?   // Viagem, Treinamento, Manutenção, etc.
  notes           String?
  status          String    @default("CONFIRMED") // CONFIRMED, CANCELLED, PENDING
  
  // Google Calendar sync
  googleEventId   String?   // ID do evento no Google Calendar
  calendarSynced  Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Multi-tenancy
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relacionamentos
  aircraftId      String
  reservedById    String    // Sócio que reservou
  pilotId         String?   // Piloto designado (pode ser o mesmo ou outro)

  aircraft        Aircraft  @relation(fields: [aircraftId], references: [id])
  reservedBy      User      @relation("BookingReservedBy", fields: [reservedById], references: [id])
  pilot           User?     @relation("BookingPilot", fields: [pilotId], references: [id])
}

// Integração com Google Calendar por usuário
model CalendarIntegration {
  id              String    @id @default(cuid())
  provider        String    @default("google") // google, outlook, apple
  accessToken     String?
  refreshToken    String?
  calendarId      String?   // ID do calendário específico
  syncEnabled     Boolean   @default(true)
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}
